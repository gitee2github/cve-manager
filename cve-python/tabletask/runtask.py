# -*- coding: UTF-8 -*-
# CVSS官网数据爬取 数据储存数据库


from tabletask import exceltask,crawltask
from dbConnecttion.MysqlConn import Mysql
import time
import os



def crawlWeb():
    mysql=Mysql()
    path="./newexcels"
    files=os.listdir(path)
    if files:
        for fileName in files:
            cveNumList=exceltask.crawlCveNum(fileName)
            urls=exceltask.crawlUrls(fileName)
            cveVersionList=exceltask.crawlCveVersion(fileName)
            # scopeTypeList=exceltask.crawlScopeType()
            packNameList=exceltask.crawlPackName(fileName)
            for i in range(0,len(urls)):
                cveNum=str(cveNumList[i]).strip()
                print(cveNum)
                # 数据库查询结果
                sql = "select * from cve_origin_excel where cve_num= %s"
                val = (cveNum,)
                resultDict = mysql.getOne(sql, val)

                if resultDict: #判断CVE是否存在数据库

                    #爬虫网页数据
                    crawlList=crawltask.crawling(urls[i])

                    #判断数据库类容是否为最新数据
                    if resultDict["nvd_score"]!=None:
                        if str(resultDict["nvd_score"])==str(crawlList[0])and str(resultDict["vector_value"],encoding="utf-8")==str(crawlList[4]):
                            if resultDict['cve_status'] in [3,4,5]:
                                updateTime = str(time.strftime("%Y-%m-%d %H:%M:%S", time.localtime()))
                                try:
                                    sql = "update cve_origin_excel set nvd_score=%s,cve_level=%s,cve_desc=%s,repair_time=%s,vector_value=%s,attack_vector=%s,access_vector=%s," \
                                          "attack_complexity=%s,access_complexity=%s,privilege_required=%s,user_interaction=%s,scope=%s,confidentiality=%s,integrity=%s" \
                                          ",availability=%s,authentication=%s,cve_status=%s,update_time=%s where cve_num=%s"
                                    val = (
                                    crawlList[0], crawlList[1], crawlList[2], crawlList[3], crawlList[4], crawlList[5],
                                    crawlList[6], crawlList[7], crawlList[8], crawlList[9],
                                    crawlList[10], crawlList[11], crawlList[12], crawlList[13], crawlList[14],
                                    crawlList[15], 1, updateTime, cveNum)
                                    mysql.update(sql, val)
                                    mysql.dispose()
                                    print("更新数据修改状态成功")

                                except IndexError as e:
                                    print("下标越界", e)
                            else:
                                print("数据库为最新数据")
                        else:
                            print("更新数据")
                            updateTime=str(time.strftime("%Y-%m-%d %H:%M:%S", time.localtime()))
                            try:
                                sql="update cve_origin_excel set nvd_score=%s,cve_level=%s,cve_desc=%s,repair_time=%s,vector_value=%s,attack_vector=%s,access_vector=%s," \
                                    "attack_complexity=%s,access_complexity=%s,privilege_required=%s,user_interaction=%s,scope=%s,confidentiality=%s,integrity=%s" \
                                    ",availability=%s,authentication=%s,cve_status=%s,update_time=%s where cve_num=%s"
                                val=(crawlList[0],crawlList[1],crawlList[2],crawlList[3],crawlList[4],crawlList[5],crawlList[6],crawlList[7],crawlList[8],crawlList[9],
                                     crawlList[10],crawlList[11],crawlList[12],crawlList[13],crawlList[14],crawlList[15],1,updateTime,cveNum)
                                mysql.update(sql,val)
                                mysql.dispose()
                            except IndexError as e:
                                print("下标越界",e)



                else:
                    print("数据库未发现数据，执行插入操作")
                    createTime=updateTime= str(time.strftime("%Y-%m-%d %H:%M:%S", time.localtime()))
                    deleteTime=None
                    cveStatus=0 #状态0表示新建，1表示修改
                    try:
                        cveUrl=str(urls[i])

                        cveVersion=str(cveVersionList[i])

                        packName=str(packNameList[i])

                        # scoreType = str(scopeTypeList[i].strip())
                        #爬虫爬取数据列表
                        list=crawltask.crawling(cveUrl)



                        sql="INSERT INTO cve_origin_excel (cve_num,cve_url,cve_version,pack_name,score_type,nvd_score,cve_level,cve_desc,repair_time,vector_value,attack_vector," \
                            "access_vector,attack_complexity,access_complexity,privilege_required,user_interaction,scope,confidentiality,integrity,availability,authentication,cve_status" \
                            ",create_time,update_time,delete_time) VALUES (%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s)"
                        val=(cveNum,cveUrl,cveVersion,packName,list[16],list[0],list[1],list[2],list[3],list[4],list[5],list[6],list[7],list[8],list[9],list[10],list[11],list[12],list[13],
                             list[14],list[15],cveStatus,createTime,updateTime,deleteTime)

                        mysql.insertOne(sql,val)
                        mysql.dispose()
                    except IndexError as e:
                        print("下标越界",e)
            exceltask.move_file(fileName)
    else:
        print("newexcels文件夹中无手动添加表")
        return False
    mysql.close()



