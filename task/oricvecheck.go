package task

import (
	"cvevulner/common"
	"cvevulner/models"
	"cvevulner/taskhandler"
	"errors"
	"github.com/astaxie/beego/config"
	"github.com/astaxie/beego/logs"
	"strings"
)

//CheckOriCve Check the CVE of the original data
func CheckOriCve() error {
	defer common.Catchs()
	logs.Info("校验原始cve数据 task start")
	// Query the cve to be processed, 1: add; 2: modify
	BConfig, err := config.NewConfig("ini", "conf/app.conf")
	if err != nil {
		logs.Error("config init error:", err)
		return err
	}
	// The amount of data processed at a time
	prcNum, err := BConfig.Int("crontab::prcnum")
	if err != nil {
		logs.Error("config crontab::prcnum error: invalid value is ", prcNum)
		return errors.New("value is nil")
	}
	// Get the data source of the table
	_, err = taskhandler.CheckCveOriginData(prcNum)
	logs.Info("校验原始cve数据 task end")
	return err
}

// Unlock database table data
func UnLockTable() error {
	defer common.Catchs()
	logs.Info("执行解锁表 task start")
	// unlock center
	models.UnLockUpdateIssueStatus(15, 0, common.GetCurTime())
	// unlock origin cve
	models.UnLockUpdateCveIssueStatus(15, 0, common.GetCurTime())
	// unlock upstream
	models.UnLockUpdateOriginStatus(15, 0, common.GetCurTime())
	// unlock excel
	models.UnLockUpdateOriginExcelStatus(15, 0, common.GetCurTime())
	logs.Info("执行解锁表 task end")
	return nil
}


// Cve handles abnormal data reprocessing
func ProcAbnCve() error {
	defer common.Catchs()
	logs.Info("纠正cve数据 task start")
	// Query the cve to be processed, 1: add; 2: modify
	BConfig, err := config.NewConfig("ini", "conf/app.conf")
	if err != nil {
		logs.Error("config init error:", err)
		return err
	}
	// The amount of data processed at a time
	prcNum, err := BConfig.Int("crontab::prcnum")
	if err != nil {
		logs.Error("config crontab::prcnum error: invalid value is ", prcNum)
		return errors.New("value is nil")
	}
	days, err := BConfig.Int("crontab::days")
	if err != nil {
		logs.Error("config crontab::days error: invalid value is ", days)
		return errors.New("value is nil")
	}
	cveStatuStr := BConfig.String("cve::abn_cve_status")
	if cveStatuStr == "" {
		logs.Error("config cve::abn_cve_status error: invalid value is ", cveStatuStr)
		return errors.New("value is nil")
	}
	st := strings.Split(cveStatuStr, ",")
	for k, v := range st {
		st[k] = "'" + v + "'"
	}
	cveSt := strings.Join(st, ",")
	// Get the data source of the table
	_, err = taskhandler.UpdateAbnCveStatus(prcNum, days, cveSt)
	logs.Info("纠正cve数据 task end")
	return err
}
