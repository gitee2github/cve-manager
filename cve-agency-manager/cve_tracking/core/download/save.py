#!/usr/bin/python3
# ******************************************************************************
# Copyright (c) Huawei Technologies Co., Ltd. 2021-2021. All rights reserved.
# licensed under the Mulan PSL v2.
# You can use this software according to the terms and conditions of the Mulan PSL v2.
# You may obtain a copy of Mulan PSL v2 at:
#     http://license.coscl.org.cn/MulanPSL2
# THIS SOFTWARE IS PROVIDED ON AN "AS IS" BASIS, WITHOUT WARRANTIES OF ANY KIND, EITHER EXPRESS OR
# IMPLIED, INCLUDING BUT NOT LIMITED TO NON-INFRINGEMENT, MERCHANTABILITY OR FIT FOR A PARTICULAR
# PURPOSE.
# See the Mulan PSL v2 for more details.
# ******************************************************************************/
import os
import re
from conf import CONFIG, settings
from logger import logger
from request import http


def _file(cve, file):
    """
    save file path

    :param cve: fiex cve number
    :param file: save path
    """
    file = os.path.join(file, cve)
    os.makedirs(file, exist_ok=True)
    file_name = (
        "fix-cve-"
        + str(sum([os.path.isfile(list_index) for list_index in os.listdir(file)]) + 1)
        + ".patch"
    )
    return os.path.join(file, file_name)


def _patch_url(url):
    download_rules = settings.configuration.get("download")
    if not download_rules:
        return url + ".patch"

    for replace in filter(lambda x: x.get("action") == "REPLACE", download_rules):
        if re.findall(replace.get("regex", ""), url):
            target_regex = replace.get("target", ["commit", "patch"])
            return re.sub(target_regex[0], target_regex[-1], url)

    for append in filter(lambda x: x.get("action") == "APPEND", download_rules):
        if re.findall(append.get("regex", ""), url):
            target_regex = append.get("target", [".patch"])
            return url + target_regex[-1]


def save_patch(patch_details, cve, path=CONFIG.PATCH_SAVE_PATH):
    """
    Download and save the patch file
    :param patch_details: patch info
    :param cve: cve number
    :param path: patch path
    :return: None
    """
    commits = set()
    for patch in patch_details:
        for issue_info in patch.get("details", list()):
            for pr in issue_info["issue"].get("prs", list()):
                commits.update(pr.get("commits", []))

    # download patch
    for url in commits:
        out_file = _file(cve=cve, file=path)
        patch_url = _patch_url(url=url) or url
        file = http.download(url=patch_url, out_fname=out_file)
        if not file:
            logger.error("Failed to download the file: %s" % patch_url)


__all__ = ("save_patch",)

