#!/usr/bin/python
# -*- coding: UTF-8 -*-

################################################################################
#
# Copyright (c) 2020 openEuler.org, Inc. All Rights Reserved
#
################################################################################
"""
Interaction between file and mysql data

Authors: xiaojianghui
Date:    10/22/2020 11:01 AM
"""

from tabletask import exceltask, crawltask
from dbConnecttion.MysqlConn import Mysql
import time
import os


def crawlWeb():
    """
        CVSS official website data crawling data storage database
    """
    path = "./newexcels"
    files = os.listdir(path)
    if files:
        mysql = Mysql()
        for fileName in files:
            cveNumList = exceltask.crawlCveNum(fileName)
            urls = exceltask.crawlUrls(fileName)
            cveVersionList = exceltask.crawlCveVersion(fileName)
            packNameList = exceltask.crawlPackName(fileName)
            for i in range(0, len(urls)):
                cveNum = str(cveNumList[i]).strip()
                print(fileName, cveNum)
                # Database query results
                sql = "select * from cve_origin_excel where cve_num= %s"
                val = (cveNum,)
                resultDict = mysql.getOne(sql, val)
                # Determine whether CVE exists in the database
                if resultDict:
                    # Crawler web data
                    crawlList = crawltask.crawling(urls[i])
                    # Determine whether the database content is the latest data
                    if resultDict["nvd_score"]:
                        if str(resultDict["nvd_score"]) == str(crawlList[0]) and str(resultDict["vector_value"],
                                                                                     encoding="utf-8") == str(
                            crawlList[4]):
                            if resultDict['cve_status'] in [3, 4, 5]:
                                updateTime = str(time.strftime("%Y-%m-%d %H:%M:%S", time.localtime()))
                                try:
                                    sql = "update cve_origin_excel set nvd_score=%s, cve_level=%s, cve_desc=%s, " \
                                          "repair_time=%s, vector_value=%s, attack_vector=%s, access_vector=%s, " \
                                          "attack_complexity=%s, access_complexity=%s, privilege_required=%s, " \
                                          "user_interaction=%s, scope=%s, confidentiality=%s, integrity=%s, " \
                                          "availability=%s, authentication=%s, cve_status=%s, update_time=%s where cve_num=%s"
                                    val = (
                                        crawlList[0], crawlList[1], crawlList[2], crawlList[3], crawlList[4],
                                        crawlList[5],
                                        crawlList[6], crawlList[7], crawlList[8], crawlList[9],
                                        crawlList[10], crawlList[11], crawlList[12], crawlList[13], crawlList[14],
                                        crawlList[15], 1, updateTime, cveNum)
                                    mysql.update(sql, val)
                                    mysql.dispose()
                                except IndexError as e:
                                    mysql.dispose(0)
                                    print("下标越界", e)
                        else:
                            updateTime = str(time.strftime("%Y-%m-%d %H:%M:%S", time.localtime()))
                            try:
                                sql = "update cve_origin_excel set nvd_score=%s, cve_level=%s, cve_desc=%s, " \
                                      "repair_time=%s, vector_value=%s, attack_vector=%s, access_vector=%s, " \
                                      "attack_complexity=%s, access_complexity=%s, privilege_required=%s, " \
                                      "user_interaction=%s, scope=%s, confidentiality=%s, integrity=%s, " \
                                      "availability=%s, authentication=%s, cve_status=%s, update_time=%s where cve_num=%s"
                                val = (
                                    crawlList[0], crawlList[1], crawlList[2], crawlList[3], crawlList[4], crawlList[5],
                                    crawlList[6], crawlList[7], crawlList[8], crawlList[9],
                                    crawlList[10], crawlList[11], crawlList[12], crawlList[13], crawlList[14],
                                    crawlList[15], 1, updateTime, cveNum)
                                mysql.update(sql, val)
                                mysql.dispose()
                            except IndexError as e:
                                print("下标越界", e)
                                mysql.dispose(0)
                    else:
                        print("error: ", resultDict)
                else:
                    print("数据库未发现数据，执行插入操作")
                    createTime = updateTime = str(time.strftime("%Y-%m-%d %H:%M:%S", time.localtime()))
                    deleteTime = None
                    # State 0 means new, 1 means modified
                    cveStatus = 0
                    try:
                        cveUrl = str(urls[i])
                        cveVersion = str(cveVersionList[i])
                        packName = str(packNameList[i])
                        listx = crawltask.crawling(cveUrl)
                        sql = "INSERT INTO cve_origin_excel (cve_num, cve_url, cve_version, pack_name, score_type, " \
                              "nvd_score, cve_level, cve_desc, repair_time, vector_value, attack_vector, " \
                              "access_vector, attack_complexity, access_complexity, privilege_required, " \
                              "user_interaction, scope, confidentiality, integrity, availability, " \
                              "authentication, cve_status, " \
                              "create_time, update_time, delete_time) " \
                              "VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, " \
                              "%s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s)"
                        val = (
                            cveNum, cveUrl, cveVersion, packName, listx[16], listx[0], listx[1], listx[2], listx[3],
                            listx[4],
                            listx[5], listx[6], listx[7], listx[8], listx[9], listx[10], listx[11], listx[12],
                            listx[13],
                            listx[14], listx[15], cveStatus, createTime, updateTime, deleteTime)
                        mysql.insertOne(sql, val)
                        mysql.dispose()
                    except IndexError as e:
                        print("下标越界", e)
                        mysql.dispose(0)
            exceltask.move_file(fileName)
        mysql.close()
    else:
        print("error: newexcels文件夹中无手动添加表")
