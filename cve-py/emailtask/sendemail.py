#!/usr/bin/python
# -*- coding: UTF-8 -*-

################################################################################
#
# Copyright (c) 2020 openEuler.org, Inc. All Rights Reserved
#
################################################################################
"""
Email notification of incorrect data

Authors: xiaojianghui
Date:    10/22/2020 11:01 AM
"""

import smtplib
import os
import email.mime.multipart
import email.mime.text
import email.mime.application as application


def send_email(smtp_host, smtp_port, sendAddr, password, recipientAddrs, subject='', content=''):
    """
        send email
    :param smtp_host:smpt.gmail.com
    :param smtp_port:587
    :param sendAddr:
    :param password:
    :param recipientAddrs:
    :param subject: title
    :param content: content
    :return:None
    """
    msg = email.mime.multipart.MIMEMultipart()
    msg['from'] = sendAddr
    msg['to'] = recipientAddrs
    msg['subject'] = subject
    content = content
    txt = email.mime.text.MIMEText(content, 'plain', 'utf-8')
    msg.attach(txt)
    # Add attachment address
    files = os.listdir("../problemexcels")
    if not files:
        print("不存在错误数据表")
        return
    for fileName in files:
        try:
            part = application.MIMEApplication(open('./problemexcels/' + fileName, 'rb').read())
            part.add_header('Content-Disposition', 'attachment', filename=fileName)
            msg.attach(part)
            smtpSSLClient = smtplib.SMTP(smtp_host, smtp_port)
            smtpSSLClient.ehlo()
            smtpSSLClient.starttls()
            loginRes = smtpSSLClient.login(sendAddr, password)
            print("登录结果:loginRes=", loginRes)
            if loginRes and loginRes[0] == 235:
                print("登录成功，code=[loginRes[0]]")
                smtpSSLClient.sendmail(sendAddr, recipientAddrs, str(msg))
                print("mail has been send successfully. message: ", str(msg))
                smtpSSLClient.quit()
            else:
                print("登录失败,code= ", loginRes[0])
        except SystemExit as e:
            print("发送失败,Exception:e= ", e)
