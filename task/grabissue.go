package task

import (
	"cvevulner/common"
	"cvevulner/taskhandler"
	"errors"
	"github.com/astaxie/beego/config"
	"github.com/astaxie/beego/logs"
	"os"
)

//GetIssueData  get the issue data
func GetIssueData()  error{
	defer common.Catchs()
	logs.Info("获取已经创建的issue数据源 task start")
	// 查询需要处理的cve, 1:新增；2：修改
	BConfig, err := config.NewConfig("ini", "conf/app.conf")
	if err != nil{
		logs.Error("config init error:", err)
		return err
	}
	owner := BConfig.String("gitee::owner")
	if owner == "" {
		logs.Error("config gitee::owner error: invalid value is ", owner)
		return errors.New("value is nil")
	}
	giteeToken := os.Getenv("GITEE_TOKEN")
	if giteeToken == "" {
		logs.Error("获取token失败, 无法获取issue任务")
		return errors.New("获取token失败, 无法获取issue任务")
	}
	errx := taskhandler.GrabIssueByOrg(giteeToken, owner)
	logs.Info("获取已经创建的issue数据源 task end")
	return errx
}