package task

import (
	"cvevulner/common"
	"cvevulner/taskhandler"
	"errors"
	"github.com/astaxie/beego/config"
	"github.com/astaxie/beego/logs"
)

//ProcCveOriginData Process raw data obtained by api
func ProcCveOriginData(prcNum, days, credibilityLevel, openeulerNum int, cveRef, owner string) (bool, error) {
	// Process raw data obtained by api
	ok, err := taskhandler.GetCveOriginData(prcNum, days, openeulerNum, credibilityLevel, cveRef)
	if !ok {
		logs.Error("接口上的原始数据处理失败(GetCveOriginData), err: ", err)
	}
	// Processing excel raw data
	okx, err := taskhandler.GetCveOriginExcelData(prcNum, days, openeulerNum, cveRef)
	if !okx {
		logs.Error("excel数据处理失败(GetCveOriginExcelData), errx: ", err)
	}
	// Compatible with created issue data
	oki, err := taskhandler.GetCveIssueData(prcNum, days, openeulerNum, cveRef, owner)
	if !oki {
		logs.Error("issue数据处理失败(GetCveIssueData), erri: ", err)
	}
	return true, nil
}

//ParamsCveOriginData Processing cve raw data
func ParamsCveOriginData() error {
	defer common.Catchs()
	logs.Info("将cve原始数据生成cve库 task start")
	// Query the cve to be processed, 1: add; 2: modify
	BConfig, err := config.NewConfig("ini", "conf/app.conf")
	if err != nil {
		logs.Error("config init error:", err)
		return err
	}
	// The amount of data processed at a time
	prcnum, err := BConfig.Int("crontab::prcnum")
	if err != nil {
		logs.Error("config crontab::prcnum error: invalid value is ", prcnum)
		return errors.New("value is nil")
	}
	// How many days have been processed to date data
	days, ok := BConfig.Int("crontab::days")
	if ok != nil {
		logs.Error("config crontab::days error:", err)
		return ok
	}
	// openeuler Number start value
	cveRef := BConfig.String("cve::cveref")
	openeulernum, ok := BConfig.Int("cve::openeulernum")
	if ok != nil {
		logs.Error("config cve::openeulernum error:", err)
		return ok
	}
	owner := BConfig.String("gitee::owner")
	// cve credibility level
	credibilityLevel, ok := BConfig.Int("cve::credibility_level")
	if ok != nil {
		logs.Error("config cve::credibility_level error:", err)
		return ok
	}
	// Get the data source of the table
	_, errx := ProcCveOriginData(prcnum, days, credibilityLevel, openeulernum, cveRef, owner)
	logs.Info("将cve原始数据生成cve库 task end")
	return errx
}
