package controllers

import (
	"cve-agency-service/common"
	"encoding/json"
	"github.com/astaxie/beego"
	"github.com/astaxie/beego/logs"
	"os/exec"
)

type TriggerTrackController struct {
	beego.Controller
}

func (c *TriggerTrackController) RetData(resp map[string]interface{}) {
	c.Data["json"] = resp
	c.ServeJSON()
}

type CveReqPramData struct {
	CveNum       string `json:"cveNum"`
	PackName     string `json:"packName"`
	PackVersion  string `json:"packVersion"`
	IssueNumber  string `json:"issueNumber"`
	AffectBranch string `json:"affectBranch"`
}

// @Title TriggerTrack
// @Description Trigger Track
// @Param	body		body 	models.TriggerTrack	true		"body for TriggerTrack content"
// @Success 200 {int} models.Id
// @Failure 403 body is empty
// @router / [post]
func (c *TriggerTrackController) Post() {
	var cvePram CveReqPramData
	req := c.Ctx.Request
	addr := req.RemoteAddr
	logs.Info("Method: ", req.Method, "Client request ip address: ", addr, ",Header: ", req.Header)
	resp := make(map[string]interface{})
	resp["errno"] = common.RecodeParamErr
	resp["errmsg"] = common.RecodeText(common.RecodeParamErr)
	defer c.RetData(resp)
	json.Unmarshal(c.Ctx.Input.RequestBody, &cvePram)
	logs.Info("trigger track request parameters: ", string(c.Ctx.Input.RequestBody))
	// Call python script
	pythonFile := beego.AppConfig.String("python_conf::python_file")
	args := []string{pythonFile, "-cve", cvePram.CveNum, "-name", cvePram.PackName, "-v",
		cvePram.PackVersion, "-branch", cvePram.AffectBranch, "-cmd", "-issue", cvePram.IssueNumber}
	//args := []string{pythonFile}
	out, err := exec.Command("python3", args...).Output()
	if err != nil {
		logs.Error("cmd python3 ==> python ", args, ",err: ", err)
		resp["errno"] = common.RecodeCmdFailed
		resp["errmsg"] = common.RecodeText(common.RecodeCmdFailed)
		return
	}
	logs.Info("out: ", string(out))
	resp["errno"] = common.RecodeOk
	resp["errmsg"] = common.RecodeText(common.RecodeOk)
	return
}
