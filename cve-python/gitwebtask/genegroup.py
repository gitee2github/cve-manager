# -*- coding: UTF-8 -*-
import requests
import lxml
import logging
from lxml.etree import HTML
from dbConnecttion.MysqlConn import Mysql
import time


class Command():
    logger = logging.getLogger('log')

    def handle(self):
        mysql = Mysql()
        url = 'https://gitee.com/openeuler/community/tree/master/sig'
        try:
            r = requests.get(url)
        except requests.exceptions.ConnectionError:
            print('ConnectionError')
        except requests.exceptions.ChunkedEncodingError:
            print('ChunkedEncodingError')
        except:
            print('Unfortunitely -- An Unknow Error Happened')
        html = HTML(r.content)
        assert isinstance(html, lxml.etree._Element)
        sigs_list = []
        i = 3
        while True:
            sig_name = html.xpath("//div[@id='tree-slider']/div[{}]/div[1]/a/@title".format(i))[0]
            if sig_name == 'sigs.yaml':
                break
            sql="select * from cve_git_repo_groups where group_name = %s"
            val=(sig_name,)
            flag=mysql.getOne(sql,val)
            if flag==False:
                print("数据库无此条数据,执行插入操作")
                sql="insert into cve_git_repo_groups (group_name) values (%s)"
                val=(sig_name,)
                mysql.insertOne(sql,val)
                mysql.dispose()

            sig_page = html.xpath("//div[@id='tree-slider']/div[{}]/div[1]/a/@href".format(i))[0]
            etherpad = 'https://etherpad.openeuler.org/p/{}-meetings'.format(sig_name)
            # 获取所有sig的名称、首页和etherpad
            sigs_list.append([sig_name, 'https://gitee.com' + sig_page, etherpad])
            i += 2
        sigs_list = sorted(sigs_list)
        print(sigs_list)
        for sig in sigs_list:
            #获取group_id
            sql="select group_id from cve_git_repo_groups where group_name = %s"
            val=(sig[0],)
            groupId=mysql.getOne(sql,val)["group_id"]
            #删除cve_gite_repo_member里面的数据
            #根据groupId
            sql1="delete from cve_gite_repo_member where group_id = %s"
            val1=(groupId,)
            mysql.delete(sql1,val1)
            mysql.dispose()
            # 获取owners
            url = 'https://gitee.com/openeuler/community/blob/master/sig/{}/OWNERS'.format(sig[0])
            r = requests.get(url)
            html = HTML(r.text)
            assert isinstance(html, lxml.etree._Element)
            res = html.xpath('//div[@class="line"]/text()')
            owners = []
            for i in res[1:]:
                maintainer = i.strip().split('-')[-1].strip()
                createTime = str(time.strftime("%Y-%m-%d %H:%M:%S", time.localtime()))
                sql="insert into cve_gite_repo_member (group_id,member_name,member_type,create_time) values (%s,%s,%s,%s)"
                val=(groupId,maintainer,"Maintainer",createTime)
                mysql.insertOne(sql,val)
                mysql.dispose()

                owners.append(maintainer)
            print(owners)
            # owners = ','.join(owners)
            # sig.append(owners)
            # group_name = sig[0]
            # home_page = sig[1]
            # etherpad = sig[2]
            # maillist = sig[3]
            # irc = sig[4]
            # owners = sig[5]

        mysql.close()
