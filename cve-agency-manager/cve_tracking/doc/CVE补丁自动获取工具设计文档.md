# CVE补丁自动获取工具设计文档

## 一、需求概述

### 1.1、需求描述

开源社区中大部分软件都是第三方开源软件，这无法避免会存在漏洞，快速发现并及时修复cve漏洞是衡量一个开源社区是否健康的重要   指标之一。cve_tracking工具旨在自动查找cve的修复补丁，减少人工查找时间，提高cve修复速度，保障社区健康运行。

### 1.2、受益人

| 角色         | 角色描述                                                     |
| ------------ | ------------------------------------------------------------ |
| 版本经理     | 负责版本发布、维护和进度看护的人员，版本发布要求解决高分CVE，cve_tracking可以帮助快速解决CVE，保证版本发布进度。 |
| 社区维护人员 | 负责修复CVE的人员，可以使用cve_tracking，减少查找工作量，提高解决速度。 |
| 社区开发人员 | 自研软件包的开发人员，可以使用补丁验证模块功能进行补丁验证。 |

### 1.3、依赖组件

| 组件                           | 组件描述                                    | 可获得性        |
| ------------------------------ | ------------------------------------------- | --------------- |
| python3                        | Python程序运行环境，需要python3.6以上版本。 | openEuler已集成 |
| python3-requests               | python发送http/https请求程序库              | openEuler已集成 |
| python3-retrying               | requests请求重试依赖程序库                  | openEuler已集成 |
| python3-concurrent-log-handler | python日志程序库，包括日志记录，日志转储    | openEuler已集成 |
| python3-pyyaml                 | python处理yaml文件程序库                    | openEuler已集成 |

### 1.4、特性需求

| 需求编号 | 需求描述  | 特性描述                                        |
| -------- | --------- | ----------------------------------------------- |
| 1        | 补丁查找  | 通过cve参考网址和查找规则进行补丁链接匹配查找。 |
| 2        | issue评论 | 将查找到的补丁链接添加到相关issue的评论中。     |
| 3        | 补丁下载  | 通过查找到的补丁链接，将补丁文件下载保存。      |
| 4        | 补丁验证  | 下载补丁文件后，进行补丁打包验证。              |



## 二、设计概述

### 2.1、 设计原则

- 数据与代码分离： 功能实现是需要考虑哪些数据是需要配置动态改变的，不可在代码中将数据写死，应提取出来做成可配置项。
- 接口与实现分离：外部依赖模块接口而不是依赖模块实现。
- 模块划分： 不同功能划分不同模块，使用命令行参数进行灵活组合，模块之间保证无循环调用。
- 并行处理：采用多线程，协程等技术，并行请求外部api，减少IO等待时间，提高处理速度。
- 变更： 架构设计变更、外部接口变更、特性需求变更需要结合开发、测试等所有相关人员经过开会讨论后决策，不可擅自变更。

## 三、需求分析

### 3.1、使用场景

- 在线使用：和cve_manager集成，提交cve的issue时自动触发，也可以通过/find-patch命令进行触发，该方式只输出参考网址，相关pr和补丁链接，无下载和验证信息。

> 评论格式
>
> | 参考网址                                                  | 关联pr                                         | 补丁链接                                                     |
> | --------------------------------------------------------- | ---------------------------------------------- | ------------------------------------------------------------ |
> | https://bugzilla.redhat.com/show_bug.cgi?id=CVE-2020-1735 | https://github.com/ansible/ansible/pull/68780/ | https://github.com/ansible/ansible/pull/68780/commits/5292482553dc409081f7f4368398358cbf9f8672，https://github.com/ansible/ansible/pull/68780/commits/5292482553dc409081f7f4368398358cbf9f8673 |
> | https://ubuntu.com/security/CVE-2019-10156                |                                                | https://github.com/ansible/ansible/pull/57188/commits/8254c266f962d5febe46396d5083bb9c1da74840，https://github.com/ansible/ansible/pull/57188/commits/fbda0028750a17a032d83dad9d1fb284f9ea68a4 |

- 本地使用：下载工具后，通过python调用，该方式支持下载补丁和验证补丁的操作。

### 3.2、用例视图

![](\images\用例图.png)

> 说明：
>
> - 社区维护人员是该工具的主要使用者，用于快速查找补丁，及时修复cve。
> - 社区开发人员可以使用补丁验证模块，快速打包验证。
> - 版本经理主要是利用该工具，能更好保障版本的顺利发布。

### 3.3、逻辑视图

![](images\逻辑视图.png)

> 说明：
>
> - 补丁查找模块：通过输入cve编号和软件包信息，在cve参考网址中查找相关内容，然后通过过滤查找补丁链接。
> - 评论模块：向cve的issue提交补丁链接相关内容。
> - 下载模块：根据找到的补丁链接，进行补丁文件下载保存。
> - 验证模块：根据下载的补丁文件和源代码进行打包验证。

### 3.4、代码结构

![](images\代码模块.png)

### 3.5、时序视图

![](images\时序图.png)

### 3.6、开发视图

![](images\代码结构.png)

### 3.7、质量设计

##### 3.7.1、性能规格

| 规格项   | 规格指标                                                     |
| -------- | ------------------------------------------------------------ |
| 提交评论 | 由于补丁平台的网络访问可能存在不稳定性，将重试三次，总时间限制为5min |
| 补丁下载 | 由于补丁平台的网络访问可能存在不稳定性以及补丁大小区别，将重试三次，总时间限制为10min |
| 补丁验证 | 由软件包编译流程和编译环境决定，无时间限制。                 |

**性能提升策略：**

![](images\性能策略.png)

##### 3.7.2、可靠性设计

结果展示多个平台的相关内容，使结果更具参考性。

##### 3.7.3、安全性设计

| 功能点           | 涉及安全项           | 解决策略                                                     |
| ---------------- | -------------------- | ------------------------------------------------------------ |
| 上游社区查找补丁 | 上游社区用户名，密码 | 不需要登录的将直接访问，必须登录的将支持用户在配置文件配置临时用户名密码。 |
| issue评论        | gitee用户名，密码    | 主要使用场景为和cve_manager集成，将使用机器人账号密码。本地执行支持用户配置临时全局环境变量。 |
| 补丁验证         | 软件包安装，编译     | 必须使用root权限的操作，需用户保证拥有对应权限，不涉及用户名密码保存。 |

### 3.8、特性清单

**AR：补丁查找**

|          SR | 描述                                                      | 工作量 |
| ----------: | --------------------------------------------------------- | ------ |
| cve信息获取 | 从四个常用cve参考网址中获取cve相关信息。                  | 1K     |
|    补丁获取 | 整合获取的cve信息，提取commits、pr、issue，分析补丁内容。 | 1k     |

**AR：issue评论**

|           SR | 描述                                                         | 工作量 |
| -----------: | ------------------------------------------------------------ | ------ |
| 评论内容拼接 | 将获取到的补丁信息，封装拼接成最终需要评论到（cve）issue中的内容。 | 0.2k   |
| 补丁信息评论 | 封装gitee对issue的评论接口，将拼接好的补丁信息添加到（cve）issue评论中。 | 0.3k   |

**AR：补丁下载**

|       SR | 描述                                 | 工作量 |
| -------: | ------------------------------------ | ------ |
| 补丁下载 | 根据获取到的补丁链接，进行下载保存。 | 0.3k   |

**AR：补丁验证**

|       SR | 描述                                                         | 工作量 |
| -------: | ------------------------------------------------------------ | ------ |
| 补丁验证 | 根据下载的补丁文件，以及软件包的gitee地址，下载源代码，修改spec文件，进行软件包打包验证。 | 0.5k   |

### 3.9、接口清单

#### 3.9.1、查找补丁信息	find_patches_info()

> 说明：在各个cve参考网址爬取cve的补丁信息，先初步记录参考网址上列出的网址。

入参：

| 名称           | 类型 | 说明                                        |
| -------------- | ---- | ------------------------------------------- |
| cve_num        | str  | cve编号                                     |
| rpm_name       | str  | rpm包名称                                   |
| *cve_plantform | str  | cve查找参考网址，可使用属性值表示，无需传入 |

返回值：

| 名称        | 类型 | 说明         |
| ----------- | ---- | ------------ |
| *patch_info | dict | 补丁相关信息 |

patch_info:

```json
{
    "plantform": "nvd_url"
    "commits": ["commit1","commit2"],
	"pr": ["pr1","pr2"],
	"issue": ["issue1","issue2"]
}
```

#### 3.9.2、查找补丁链接	find_patches_detail()

> 说明：对find_patches_info查询的信息做进一步处理，获取补丁链接。	

入参：

| 名称        | 类型       | 说明                                      |
| ----------- | ---------- | ----------------------------------------- |
| patch_infos | list(dict) | find_patches_info()接口查出的补丁信息列表 |

patch_infos：

```json
[
{
    "plantform": "nvd_url"
    "commits": ["commit11","commit12"],
	"pr": ["pr11","pr12"],
	"issue": ["issue11","issue12"]   
},
{
    "plantform": "buzila_url"
    "commits": ["commit21","commit22"],
	"pr": ["pr21","pr22"],
	"issue": ["issue21","issue22"]
}
]
```

返回值：

| 名称          | 类型       | 说明                 |
| ------------- | ---------- | -------------------- |
| patch_details | list(dict) | 补丁链接详细信息列表 |

patch_details：

```json
[
    {   
        "plantform": "nvd_url",
        "details": {
            "pr_url1":["commit11","commit12"],
            "pr_url2":["commit21","commit22"],
             None:["commit31","commit32"]
        }
    },
    {
        "plantform": "buzila_url",
        "details": {
            "pr_url1":["commit11","commit12"],
            "pr_url2":["commit21","commit22"],
             None:["commit31","commit32"]
        }
    }
]
```

#### 3.9.3、评论issue	add_comment()

> 说明：根据patch_details获取的补丁详细信息，拼接issue评论内容，添加issue评论。

入参：

| 名称          | 类型       | 说明                                                  |
| ------------- | ---------- | ----------------------------------------------------- |
| issue_num     | str        | issue编号                                             |
| patch_details | list(dict) | 补丁链接详细信息列表，结构见find_patches_detail返回值 |

返回值：

| 名称 | 类型 | 说明                                   |
| ---- | ---- | -------------------------------------- |
| code | str  | 调用gitee api添加issue评论返回的状态码 |
| text | str  | 调用gitee api添加issue评论返回的信息   |

#### 3.9.4、下载保存	save_patch()

> 说明：根据find_patches_detail获取到的补丁信息，进行补丁文件下载。

入参：

| 名称          | 类型       | 说明                                                  |
| ------------- | ---------- | ----------------------------------------------------- |
| patch_details | list(dict) | 补丁链接详细信息列表，结构见find_patches_detail返回值 |
| cve_num       | str        | cve编号                                               |
| *save_path    | str        | 补丁文件保存路径，可不指定，有默认值。                |

返回值：

> 无返回值，下载信息记录日志

#### 3.9.5、打包验证	packing_source()

> 说明：根据save_patch保存的补丁文件，以及软件包信息，从gitee拉取源代码，修改spec，进行打包测试。

入参：

| 名称         | 类型 | 说明                                          |
| ------------ | ---- | --------------------------------------------- |
| rpm_name     | str  | 补丁对应的软件包名称，用于从gitee中拉取源代码 |
| *source_path | str  | 源码下载路径，可不指定，有默认值。            |
| *save_path   | str  | 补丁文件保存路径，可不指定，有默认值。        |

返回值：

> 无返回值，编译过程记录文件，编译结果记录日志。