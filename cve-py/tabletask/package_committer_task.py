#!/usr/bin/python3
# -*- coding: UTF-8 -*-


import os
import xlrd
import time
import hashlib
from dbConnecttion.MysqlConn import Mysql
from downloadtask import downloadfiletask


def parse_excel(file_name):
    """
        parse excel data
    parse: file_name
    return: list
    """
    package_name_list = []
    issue_assignee_list = []
    try:
        data = xlrd.open_workbook('./package_committer_excels/' + file_name)
        table_one = data.sheet_by_name("Sheet1")
        row_number = table_one.nrows
        for i in range(1, row_number):
            package_name_list.append(table_one.cell(i, 0).value)
            issue_assignee_list.append(table_one.cell(i, 1).value)
    except IndexError as e:
        print("Subscript out of bounds", e)
    except xlrd.XLRDError as e:
        print("Form not found：Sheet1", e)
    return package_name_list, issue_assignee_list


def cur_date():
    """
    current date
    :return createTime: string
    """
    create_time = time.strftime("%Y-%m-%d %H:%M:%S", time.localtime())
    return create_time


def import_data():
    """
        import excel
        :param
        :return none
    """
    downloadfiletask.handle_four()
    mysql = Mysql()
    files = os.listdir('./package_committer_excels')
    for filename in files:
        with open('./package_committer_excels/' + filename, 'rb') as f:
            sha1obj = hashlib.sha1()
            sha1obj.update(f.read())
            hash_value = sha1obj.hexdigest()
            print(filename, hash_value)
            f.close()
        sql = "select file_hash from cve_file_hash where file_name = %s"
        val = (filename,)
        file_hash = mysql.getOne(sql, val)
        if file_hash:
            if hash_value == file_hash['file_hash']:
                print("文件已解析:" + filename)
                os.remove('./package_committer_excels/' + filename)
                continue
        sql = "insert into cve_file_hash (file_name, file_hash) values (%s, %s)"
        val = (filename, hash_value)
        mysql.insertOne(sql, val)
        mysql.dispose()
        result = parse_excel(filename)
        for i in range(0, len(result[0])):
            sql = 'insert ignore into cve_spec_issue_assigness (package_name, issue_assignee, status, create_time) ' \
                  'values (%s, %s, %s, %s)'
            val = (result[0][i], result[1][i], 1, cur_date())
            mysql.insertOne(sql, val)
            mysql.dispose()
            print('插入数据{}:{}'.format(result[0][i], result[1][i]))
        os.remove('./package_committer_excels/' + filename)
    mysql.close()
