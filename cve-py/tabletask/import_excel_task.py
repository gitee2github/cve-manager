#!/usr/bin/python
# -*- coding: UTF-8 -*-
import xlrd
import time
import os
from dbConnecttion.MysqlConn import Mysql


def parse_excel(file_name):
    pack_name_list = []
    version_list = []
    branchs_list = []
    status_list = []
    try:
        data = xlrd.open_workbook('./import_excels/' + file_name)
        table_one = data.sheet_by_name("Sheet1")
        row_number = table_one.nrows
        for i in range(1, row_number):
            pack_name_list.append(table_one.cell(i, 0).value)
        for i in range(1, row_number):
            version_list.append(table_one.cell(i, 1).value)
        for i in range(1, row_number):
            status_list.append(table_one.cell(i, 2).value)
        for i in range(1, row_number):
            branchs_list.append(table_one.cell(i, 3).value)
    except IndexError as e:
        print("Subscript out of bounds", e)
    except xlrd.XLRDError as e:
        print("Form not found：Sheet1", e)
    return pack_name_list, version_list, status_list, branchs_list


def cur_date():
    """
    current date
    :return createTime: string
    """
    create_time = time.strftime("%Y-%m-%d %H:%M:%S", time.localtime())
    return create_time


def import_data():
    files = os.listdir('./import_excels')
    for file_name in files:
        result = parse_excel(file_name)
        mysql = Mysql()
        for i in range(0, len(result[0])):
            sql = 'select * from cve_issue_repo_whitelist where package_name = %s and version = %s'
            val = (result[0][i], result[1][i])
            mysql_data = mysql.getOne(sql, val)
            if mysql_data:
                print("更新数据package_name:" + result[0][i])
                sql = 'update cve_issue_repo_whitelist set status = %s, branchs = %s, update_time = %s where ' \
                      'package_name = %s and version = %s'
                val = (result[2][i], result[3][i], cur_date(), result[0][i], result[1][i])
                mysql.update(sql, val)
                mysql.dispose()
            else:
                print('插入数据')
                sql = 'insert into cve_issue_repo_whitelist (package_name, version, status, branchs, create_time, ' \
                      'update_time, delete_time) values (%s, %s, %s, %s, %s, %s, %s)'
                val = (result[0][i], result[1][i], result[2][i], result[3][i], cur_date(), None, None)
                mysql.insertOne(sql, val)
                mysql.dispose()
        mysql.close()
        os.remove('./import_excels/' + file_name)
